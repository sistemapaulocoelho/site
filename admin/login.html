<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Academia Paulo Coelho</title>
    <link rel="icon" type="image/x-icon" href="../assets/favico2.ico">
    <link rel="stylesheet" href="css/login.css">
    <link rel="stylesheet" href="css/Login-respons.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">
                    <img src="../assets/Logo.png" alt="Academia Paulo Coelho" class="logo-image">
                </div>
                <h1>Academia Paulo Coelho</h1>
                <p>Painel Administrativo</p>
            </div>

            <form class="login-form" id="loginForm">
                <div id="error-message" class="error-message hidden">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span class="message-text">Mensagem de erro aqui</span>
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="email" name="email" required placeholder="Digite seu email"
                            autocomplete="off">
                    </div>
                </div>

                <div class="form-group">
                    <label for="password">Senha</label>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" name="password" required placeholder="Digite sua senha"
                            autocomplete="off">
                        <button type="button" class="toggle-password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-options">
                    <a href="forgot-senha.html" class="forgot-password">Esqueceu a senha?</a>
                </div>

                <button type="submit" class="login-btn" id="loginBtn">
                    <span class="btn-text">Entrar</span>
                    <span class="btn-loading hidden">
                        <i class="fas fa-spinner fa-spin"></i> Verificando...
                    </span>
                </button>
            </form>

            <div class="login-footer">
                <p>&copy; 2024 Academia Paulo Coelho. Todos os direitos reservados.</p>
            </div>
        </div>

        <div class="background-animation">
            <div class="floating-shape shape-1"></div>
            <div class="floating-shape shape-2"></div>
            <div class="floating-shape shape-3"></div>
            <div class="floating-shape shape-4"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <!-- <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script> -->

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Configuração do Firebase
        const configuracaoFirebase = {
            apiKey: "AIzaSyCGudG7CvPLW_GE8JycQrC0xPE7_BvIDro",
            authDomain: "academia-27102.firebaseapp.com",
            projectId: "academia-27102",
            storageBucket: "academia-27102.firebasestorage.app",
            messagingSenderId: "702608503871",
            appId: "1:702608503871:web:c5359c42513615ffd4348a"
        };

        const app = initializeApp(configuracaoFirebase);
        const bancoDeDados = getFirestore(app);
        const autenticacao = getAuth(app);

        // Toggle de mostrar/ocultar senha
        document.querySelector('.toggle-password').addEventListener('click', function () {
            var passwordField = document.getElementById('password');
            var icon = this.querySelector('i');

            // Alternar o tipo de input entre 'password' e 'text'
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash'); // Ícone de olho riscado
            } else {
                passwordField.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye'); // Voltar ao ícone de olho
            }
        });

        // ################################################################################
        // Função para armazenar no localStorage
        if (typeof (Storage) !== "undefined") {
            console.log("localStorage está disponível");
        } else {
            console.log("localStorage não está disponível");
        }

        async function determinarFuncaoUsuario() {
            try {
                // Obtém o valor do email da caixa de entrada
                const emailUsuario = document.getElementById('email').value;

                // Busca na coleção "usuarios" pelo email
                const queryUsuario = await getDocs(query(collection(bancoDeDados, "usuarios"), where("email", "==", emailUsuario)));

                // Verifica se o usuário foi encontrado e se ele é um ADMIN
                // Verifica se o usuário foi encontrado
                if (!queryUsuario.empty) {
                    const dadosUsuario = queryUsuario.docs[0].data();
                    // Retorna o valor presente no campo "funcao" do usuário
                    return dadosUsuario.funcao;
                }
                // Se o usuário não for encontrado, retorna "Membro" como padrão
                return "Aluno";
            } catch (erro) {
                console.error("Erro ao determinar função do usuário:", erro);
                return "Aluno";
            }
        }


        // Função de login
        const formulario = document.getElementById('loginForm');

        formulario.addEventListener('submit', async function (evento) {
            evento.preventDefault();

            const email = document.getElementById('email').value;
            const senha = document.getElementById('password').value;

            const loginBtn = document.getElementById('loginBtn');
            const btnText = loginBtn.querySelector('.btn-text');
            const btnLoading = loginBtn.querySelector('.btn-loading');

            // Ativar o estado de carregamento
            loginBtn.classList.add('loading');
            btnText.classList.add('hidden');
            btnLoading.classList.remove('hidden');

            try {
                // console.log("Tentando autenticar usuário");
                const credencialUsuario = await signInWithEmailAndPassword(autenticacao, email, senha);
                // console.log("Usuário autenticado com sucesso");

                const usuario = credencialUsuario.user;

                // Agora, buscamos os dados do usuário no Firestore com base no email
                const queryUsuario = await getDocs(query(collection(bancoDeDados, "usuarios"), where("email", "==", email)));

                // Verifica se o usuário foi encontrado
                if (!queryUsuario.empty) {
                    const dadosUsuario = queryUsuario.docs[0].data();
                    // Armazenar no localStorage os dados do usuário
                    localStorage.setItem('nomeUsuario', dadosUsuario.nome);
                    localStorage.setItem('emailUsuario', dadosUsuario.email);
                    localStorage.setItem('funcaoUsuario', dadosUsuario.funcao);
                    // console.log("Dados do usuário armazenados no localStorage");
                }

                setTimeout(() => {
                    window.location.href = 'painel.html';
                }, 1000);


            } catch (erro) {
                let mensagem = "Email ou Senha inválido. Tente novamente.";

                switch (erro.code) {
                    case 'auth/invalid-email':
                        mensagem = "O email fornecido não é válido. Por favor, verifique e tente novamente.";
                        break;
                    case 'auth/user-not-found':
                        mensagem = "Não encontramos uma conta com este email. Você gostaria de criar uma nova conta?";
                        break;
                    case 'auth/wrong-password':
                        mensagem = "A senha está incorreta. Por favor, verifique e tente novamente.";
                        break;
                    case 'auth/too-many-requests':
                        mensagem = "Muitas tentativas de login. Por favor, aguarde um momento antes de tentar novamente.";
                        break;
                    case 'auth/internal-error':
                        if (erro.message.includes('INVALID_LOGIN_CREDENTIALS')) {
                            mensagem = "Email ou senha inválidos. Por favor, verifique suas credenciais e tente novamente.";
                        }
                        break;
                }

                alert(mensagem);
            } finally {
                // Finaliza o carregamento
                loginBtn.classList.remove('loading');
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
            }
        });

    </script>
</body>

</html>